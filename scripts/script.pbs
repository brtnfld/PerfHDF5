#!/bin/bash

#PBS -l nodes=32:ppn=8:xe
#PBS -l walltime=02:00:00
#PBS -N the_big_job
#PBS -m abe
#PBS -M frank.willmore@hdfgroup.org
#PBS -e $PBS_JOBNAME.err
#PBS -o $PBS_JOBNAME.out

. processor_geometry.sh

# by default, everything is off
PRECREATE=
COLLECTIVE_WRITE=
SET_COLLECTIVE_METADATA=
EARLY_ALLOCATION=
NEVER_FILL=

#==== edit this section ======================================================

# set any non-empty value if RUNNING_ON_BW 
RUNNING_ON_BW=
# set what processor configurations (first num is ignored on jelly)
CONFIGURATIONS="8_8 8_16 8_32"

PRECREATE=precreate
COLLECTIVE_WRITE=collective_write
SET_COLLECTIVE_METADATA=set_collective_metadata
EARLY_ALLOCATION=early_allocation
NEVER_FILL=never_fill
TIME_STEPS=5

#=== do not edit below =======================================================

rm -f seism-test.h5


for config in `echo $CONFIGURATIONS`
do
    ppn=`echo $config | awk '{split($0, a, "_"); print a[1]}'`
    processors=`echo $config | awk '{split($0, a, "_"); print a[2]}'`
    p_geom=`processor_geometry $processors` 

    printf "###\t %d processors, %d per node\n" $processors $ppn

    if [ "$RUNNING_ON_BW"x == x ]; then
        echo "running on jelly... "
        MPI_COMMAND=mpiexec
        SEISM_CORE=$WORK/bw/seism-core/seism-core-slice
        SCRIPTS_DIR=$WORK/bw/seism-core/scripts
        LAUNCH_COMMAND="$MPI_COMMAND -n $processors $SEISM_CORE"
    else
        echo "running on BW... "
        #. ~/local/build_hdf5/NCSA_Blue_Waters/env_hdf5-1.10.0.sh
        module load cray-hdf5-parallel/1.10.0 
        module unload darshan
        ldd $SEISM_CORE
        MPI_COMMAND=aprun
        SEISM_CORE=/u/sciteam/willmore/seism-core/seism-core-slice
        SCRIPTS_DIR=/u/sciteam/willmore/seism-core/seism-core-slice/scripts
        lfs setstripe -s 1048576 -c 1 seism-test.h5 
        LAUNCH_COMMAND="$MPI_COMMAND -N$ppn -n $processors $SEISM_CORE"
    fi

$LAUNCH_COMMAND << EOF
processor $p_geom
chunk 160 80 2048
domain 160 80 2048
time $TIME_STEPS
$PRECREATE
$COLLECTIVE_WRITE
$SET_COLLECTIVE_METADATA
$EARLY_ALLOCATION
$NEVER_FILL
DONE
EOF

# done with this processor configuration, end of for...do...done loop
done
